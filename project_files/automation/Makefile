# Makefile for Customer Churn Prediction Project
# Automated tasks for development and deployment

.PHONY: help install test lint format clean build run-api train-model docker-build docker-run sync-all

# Default target
help:
	@echo "ğŸ¤– Customer Churn Prediction - Automated Tasks"
	@echo "=============================================="
	@echo ""
	@echo "ğŸ“¦ Setup & Installation:"
	@echo "  install        Install all dependencies"
	@echo "  install-dev    Install development dependencies"
	@echo ""
	@echo "ğŸ§ª Testing & Quality:"
	@echo "  test           Run all tests"
	@echo "  lint           Run code quality checks"
	@echo "  format         Format code with Black and Ruff"
	@echo "  quality        Run lint + format + test"
	@echo ""
	@echo "ğŸš€ Development:"
	@echo "  run-api        Start FastAPI server"
	@echo "  train-model    Train the ML model"
	@echo "  monitor        Run model monitoring"
	@echo "  retrain        Run model retraining"
	@echo ""
	@echo "ğŸ³ Docker:"
	@echo "  docker-build   Build Docker image"
	@echo "  docker-run     Run with Docker Compose"
	@echo "  docker-stop    Stop Docker services"
	@echo ""
	@echo "ğŸ”¬ MLflow:"
	@echo "  mlflow         Run MLflow experiments"
	@echo "  mlflow-ui      Start MLflow UI"
	@echo ""
	@echo "ğŸ” Monitoring:"
	@echo "  monitoring     Run monitoring demo"
	@echo "  monitor-sched  Run scheduled monitoring"
	@echo ""
	@echo "ğŸ”„ Sync & Maintenance:"
	@echo "  sync-all       Sync all configuration files"
	@echo "  clean          Clean temporary files"
	@echo "  build          Build project artifacts"
	@echo ""

# Installation
install:
	@echo "ğŸ“¦ Installing dependencies..."
	uv sync

install-dev:
	@echo "ğŸ“¦ Installing development dependencies..."
	uv sync --dev

# Testing and Quality
test:
	@echo "ğŸ§ª Running tests..."
	uv run pytest

lint:
	@echo "ğŸ” Running code quality checks..."
	uv run ruff check project_files/src/
	uv run black --check project_files/src/

format:
	@echo "ğŸ¨ Formatting code..."
	uv run ruff format project_files/src/
	uv run black project_files/src/
	uv run ruff check --fix project_files/src/

quality: lint format test
	@echo "âœ… All quality checks completed!"

# Development
run-api:
	@echo "ğŸš€ Starting FastAPI server..."
	uv run python project_files/src/api/fastapi_app.py

train-model:
	@echo "ğŸ¤– Training ML model..."
	uv run python project_files/src/customer_churn_prediction.py

monitor:
	@echo "ğŸ“Š Running model monitoring..."
	uv run python project_files/src/model_retraining/model_monitoring.py

retrain:
	@echo "ğŸ”„ Running model retraining..."
	uv run python project_files/src/model_retraining/model_retraining.py

# Docker
docker-build:
	@echo "ğŸ³ Building Docker image..."
	docker build -t churn-prediction .

docker-run:
	@echo "ğŸ³ Starting Docker services..."
	docker-compose up --build

docker-stop:
	@echo "ğŸ³ Stopping Docker services..."
	docker-compose down

# Sync and Maintenance
sync-all:
	@echo "ğŸ”„ Syncing all configuration files..."
	./sync_config.ps1
	./sync_docker.ps1
	./sync_linting.ps1

clean:
	@echo "ğŸ§¹ Cleaning temporary files..."
	find . -type f -name "*.pyc" -delete
	find . -type d -name "__pycache__" -delete
	find . -type d -name "*.egg-info" -exec rm -rf {} +
	find . -type d -name ".pytest_cache" -exec rm -rf {} +
	find . -type d -name ".mypy_cache" -exec rm -rf {} +

build: clean install-dev quality
	@echo "ğŸ—ï¸ Building project artifacts..."
	@echo "âœ… Build completed successfully!"

# Pre-commit hooks
install-hooks:
	@echo "ğŸ”— Installing pre-commit hooks..."
	uv run pre-commit install

run-hooks:
	@echo "ğŸ”— Running pre-commit hooks..."
	uv run pre-commit run --all-files

# Quick development workflow
dev: install-dev quality run-api
	@echo "ğŸš€ Development environment ready!"

# Production deployment
prod: install docker-build docker-run
	@echo "ğŸš€ Production deployment ready!"

# Model pipeline
pipeline: train-model monitor retrain
	@echo "ğŸ”„ Model pipeline completed!"

# MLflow experiments
mlflow:
	@echo "ğŸ”¬ Running MLflow experiments..."
	uv run python project_files/mlflow/run_experiments.py

mlflow-ui:
	@echo "ğŸ”¬ Starting MLflow UI..."
	./project_files/mlflow/start_mlflow_ui.ps1

# Monitoring
monitoring:
	@echo "ğŸ” Running monitoring demo..."
	uv run python project_files/monitoring/run_monitoring.py --mode demo

monitor-sched:
	@echo "ğŸ• Running scheduled monitoring..."
	uv run python project_files/monitoring/run_monitoring.py --mode scheduled 